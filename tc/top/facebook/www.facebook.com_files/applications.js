/*       Source:  Global Cache                                                                */
/*     Location:  js/presence/applications.js r121055                                         */
/*      Machine:  10.16.140.108                                                               */
/*    Generated:  September 13th 2008 1:22:10 AM PDT                                          */
/*    HTTP Host:  static.ak.fbcdn.net                                                         */
/*       Locale:  nu_ll                                                                       */


function ApplicationDock(applications,bookmarkableApp){this.applications={};this.sortedList=[];this.bookmarkableApp=bookmarkableApp||null;this.menuLoaded=false;this.menuOpen=false;this.menuWrapperID='presence_applications';this.applicationTabID='presence_applications_tab';this.applicationMenuContentID='presence_applications_content';this.menuWrapper=$(this.menuWrapperID);this.applicationTab=$(this.applicationTabID);this.applicationMenuContainer=$(this.applicationMenuContentID);this.iconGardenContainer=$('presence_applications_icon_garden');this.bookmarkableAppWrapper=$('bookmarkable_app');this.bookmarkableAppContainer=$('presence_applications_bookmark_app');this.sortableRoot=null;this.sortableGroup=null;this.extendedSortableGroup=null;this.extendedSortableRoot=null;this.iconGardenSortableGroup=null;this.iconGardenSortableRoot=null;this.currentIconGardenDraggableKey=null;this._init(applications);}
copy_properties(ApplicationDock,{NUM_SHOWN:6,BOOKMARKS_CHANGED:'bookmarks_changed',SaveBookmarksSource:{ICON_GARDEN:1,APPLICATION_MENU:2,BOOKMARK_CURRENT_APP:3}});ApplicationDock.prototype={_init:function(applications){this.applications=applications;this.sortedList=this._getSortedList();this._renderIconGarden();if(!is_empty(this.bookmarkableApp)){this._renderBookmarkableApp();}
this._initIconGardenSortables.bind(this).defer();presence.registerMsgHandler(this._handleMsg.bind(this));},_getSortedList:function(applications){applications=applications||this.applications;var array=keys(applications);array=mapToInt(array);this._sort(array,applications);return array;},_sort:function(array,applications){var compareFunction=this._sortApps.bind(null,applications);array.sort(compareFunction);},_sortApps:function(applications,id1,id2){return applications[id1].order-applications[id2].order;},_renderApplicationMenu:function(){DOM.setContent(this.applicationMenuContainer,HTML(this._renderAppMenuContent()));},_renderAppMenuContent:function(){var markupArr=['<ul id="application_menu_root">'];var secondaryUl=false;for(var i=0;i<this.sortedList.length;i++){var appID=this.sortedList[i];if(i==ApplicationDock.NUM_SHOWN){secondaryUl=true;markupArr.push(this._renderAppMenuContentHelper());}
markupArr.push('<li id="',this._getApplicationMenuItemId(appID),'"',' class="clearfix">',this._renderApplicationMenuItem(appID),'</li>');}
if(!secondaryUl){markupArr.push(this._renderAppMenuContentHelper());}
markupArr.push('</ul>');return markupArr.join('');},_renderAppMenuContentHelper:function(){return['</ul>','<div class="divider"></div>','<ul id="application_menu_extended_root">'].join('');},_renderApplicationMenuItem:function(appID){var appInfo=this.applications[appID];var markupArr=['<a id="',this._getApplicationMenuLinkId(appID),'" href="',appInfo['href'],'">','<img src="',appInfo['new_icon'],'" width="16px" />',htmlize(appInfo['name']),'</a>'];return markupArr.join('');},_getApplicationMenuItemId:function(appID){return'application_menu_'+appID;},_getApplicationMenuLinkId:function(appID){return'application_menu_link_'+appID;},toggleTab:function(){if(!this.menuOpen){this._openTab();}else{this._closeTab();}},_openTab:function(){if(this.menuOpen){return;}
if(!this.menuLoaded){this._renderApplicationMenu();this._initApplicationMenuSortables.bind(this).defer();this.menuLoaded=true;}
presence.openTab(this.menuWrapperID,this.applicationTabID,this.applicationMenuContentID);this.menuOpen=true;},_closeTab:function(){presence.toggleTab(this.menuWrapperID,this.applicationTabID,this.applicationMenuContentID);this.menuOpen=false;},_initApplicationMenuSortables:function(){this.sortableRoot=$('application_menu_root');this.sortableGroup=new SortableGroup();var source=ApplicationDock.SaveBookmarksSource.APPLICATION_MENU;this.sortableGroup.setOrderChangeHandler(this._saveBookmarksOrder.bind(this,source));var sortableGroup=this.sortableGroup;for(var i=0;i<this.sortedList.length;i++){var appID=this.sortedList[i];if(i==ApplicationDock.NUM_SHOWN){this._initExtendedApplicationMenuSortables();sortableGroup=this.extendedSortableGroup;}
this._addApplicationMenuSortable(appID,sortableGroup);}},_initExtendedApplicationMenuSortables:function(){this.extendedSortableGroup=new SortableGroup();this.extendedSortableRoot=$('application_menu_extended_root');this.sortableGroup.link(this.extendedSortableGroup);this.sortableGroup.setLinkJumpHandler(this._onsortableLinkJump.bind(this));var source=ApplicationDock.SaveBookmarksSource.APPLICATION_MENU;this.extendedSortableGroup.setOrderChangeHandler(this._saveBookmarksOrder.bind(this,source));},_addApplicationMenuSortable:function(appID,sortableGroup){var obj=$(this._getApplicationMenuItemId(appID));var handle=$(this._getApplicationMenuLinkId(appID));sortableGroup.addSortable(appID,obj,handle);},_resetApplicationMenu:function(){if(!this.menuLoaded){return;}
this.sortableGroup.destroy();if(this.extendedSortableGroup){this.extendedSortableGroup.destroy();}
this._renderApplicationMenu();this._initApplicationMenuSortables.bind(this).defer();},_onsortableLinkJump:function(key){var order=this.sortableGroup.getOrder(),migrateKey=null;if(order.length>ApplicationDock.NUM_SHOWN){for(var i=order.length-1;i>=0;i--){if(order[i]!=key){migrateKey=order[i];break;}}
this.extendedSortableRoot.insertBefore($(this._getApplicationMenuItemId(migrateKey)),this.extendedSortableRoot.firstChild);this.extendedSortableGroup.migrateLinkedSortable(migrateKey);}else if(order.length<ApplicationDock.NUM_SHOWN){order=this.extendedSortableGroup.getOrder();for(var i=0;i<order.length;i++){if(order[i]!=key){migrateKey=order[i];break;}}
DOM.insertAfter(this.sortableRoot,this.sortableRoot.lastChild,$(this._getApplicationMenuItemId(migrateKey)));this.sortableGroup.migrateLinkedSortable(migrateKey);}},_saveBookmarksOrder:function(source){var order;if(source==ApplicationDock.SaveBookmarksSource.APPLICATION_MENU){order=this.sortableGroup.getOrder();}else{order=this.iconGardenSortableGroup.getOrder();if(source==ApplicationDock.SaveBookmarksSource.BOOKMARK_CURRENT_APP){order.push(this._getAppShaftedByBookmarkableApp());}}
if(this.extendedSortableGroup){order=order.concat(this.extendedSortableGroup.getOrder());}else if(!this.menuLoaded&&this.sortedList.length>ApplicationDock.NUM_SHOWN){order=order.concat(this.sortedList.slice(ApplicationDock.NUM_SHOWN));}
order=unique(order);new AsyncRequest().setURI('/ajax/edit_app_settings.php').setData({reorder_bookmarks:1,app_ids:order}).setHandler(this._saveBookmarksHandler.bind(this,order,source)).send();},_saveBookmarksHandler:function(appIDs,source){this._updateSortedList(appIDs);switch(source){case ApplicationDock.SaveBookmarksSource.APPLICATION_MENU:this._resetIconGarden();break;case ApplicationDock.SaveBookmarksSource.ICON_GARDEN:case ApplicationDock.SaveBookmarksSource.BOOKMARK_CURRENT_APP:this._resetApplicationMenu();break;}},_updateSortedList:function(appIDs){this.sortedList=[];for(var i=0;i<appIDs.length;i++){this.sortedList.push(parseInt(appIDs[i],10));}},_renderIconGarden:function(){DOM.setContent(this.iconGardenContainer,HTML(this._renderIconGardenContent()));},_renderIconGardenContent:function(){var markupArr=['<div id="application_icon_garden_root"',' class="icon_garden_root">'];for(var i=0,length=Math.min(ApplicationDock.NUM_SHOWN,this.sortedList.length);i<length;i++){var appID=this.sortedList[i];markupArr.push('<div id="',this._getApplicationIconGardenItemId(appID),'"',' class="icon_garden_elem">',this._renderApplicationIconGardenItem(appID),'</div>');}
markupArr.push('</div>');return markupArr.join('');},_renderApplicationIconGardenItem:function(appID){var appInfo=this.applications[appID];var markupArr=['<div class="icon_garden_inner">','<a id="',this._getApplicationIconGardenLinkId(appID),'"',' onmouseover="applicationDock.mouseOverIconGarden(',appID,');"',' onmouseout="applicationDock.MouseOutIconGarden(',appID,');"',' href="',appInfo['href'],'">','<img src="',appInfo['new_icon'],'" width="16px" />','<div class="titletip">','<strong>',htmlize(appInfo['name']),'</strong>','</div>','</a>','</div>'];return markupArr.join('');},mouseOverIconGarden:function(appID){if(shown(this.menuWrapper)){return;}
if(!this.currentIconGardenDraggableKey||this.currentIconGardenDraggableKey!=appID){CSS.addClass(this._getApplicationIconGardenItemId(appID),'hover');}},MouseOutIconGarden:function(appID){CSS.removeClass(this._getApplicationIconGardenItemId(appID),'hover');},_grabCallback:function(appID){this.currentIconGardenDraggableKey=appID;},_dropCallback:function(appID){this.currentIconGardenDraggableKey=null;},_getApplicationIconGardenItemId:function(appID){return'application_icon_garden_'+appID;},_getApplicationIconGardenLinkId:function(appID){return'application_icon_garden_link_'+appID;},_initIconGardenSortables:function(){this.iconGardenSortableGroup=new SortableGroup();this.iconGardenSortableRoot=$('application_icon_garden_root');var source=ApplicationDock.SaveBookmarksSource.ICON_GARDEN;this.iconGardenSortableGroup.setOrderChangeHandler(this._saveBookmarksOrder.bind(this,source));for(var i=0,length=Math.min(this.sortedList.length,ApplicationDock.NUM_SHOWN);i<length;i++){this._addIconGardenSortable(this.sortedList[i]);}},_addIconGardenSortable:function(appID){var obj=$(this._getApplicationIconGardenItemId(appID));var handle=$(this._getApplicationIconGardenLinkId(appID));this.iconGardenSortableGroup.addSortable(appID,obj,handle).setGrabCallback(this._grabCallback.bind(this)).setDropCallback(this._dropCallback.bind(this));},_resetIconGarden:function(){this.iconGardenSortableGroup.destroy();this._renderIconGarden();this._initIconGardenSortables.bind(this).defer();},_renderBookmarkableApp:function(){DOM.setContent(this.bookmarkableAppContainer,HTML(this._renderBookmarkableAppContent()));CSS.removeClass(this.bookmarkableAppWrapper,'hidden_elem');},_hideBookmarkableApp:function(){CSS.addClass(this.bookmarkableAppWrapper,'hidden_elem');},_renderBookmarkableAppContent:function(){var appInfo=values(this.bookmarkableApp)[0];var markupArr=['<a',' onclick="applicationDock.bookmarkCurrentApp(); return false;"',' onmouseover="applicationDock.mouseOverBookmarkableApp();return false;"',' onmouseout="applicationDock.mouseOutBookmarkableApp();return false;"',' href="#">','<span class="bookmark_app_plus"></span>','<img src="',appInfo['new_icon'],'" width="16px" />','<div class="titletip">','<strong>',tx('pa01'),'</strong>','</div>','</a>'];return markupArr.join('');},mouseOverBookmarkableApp:function(){CSS.addClass(this.bookmarkableAppWrapper,'hover');},mouseOutBookmarkableApp:function(){CSS.removeClass(this.bookmarkableAppWrapper,'hover');},setBookmarkableApp:function(bookmarkableApp){this.bookmarkableApp=bookmarkableApp;if(is_empty(this.bookmarkableApp)){this._hideBookmarkableApp();}else{this._renderBookmarkableApp();}},_getAppShaftedByBookmarkableApp:function(){return this.sortedList[ApplicationDock.NUM_SHOWN-1];},bookmarkCurrentApp:function(){var appID=keys(this.bookmarkableApp)[0];var existingApp=this.applications[appID];this.applications[appID]=this.bookmarkableApp[appID];var div=$N('div',{id:this._getApplicationIconGardenItemId(appID),className:'icon_garden_elem'},HTML(this._renderApplicationIconGardenItem(appID)));if(this.sortedList.length>=ApplicationDock.NUM_SHOWN){this.iconGardenSortableRoot.replaceChild(div,this.iconGardenSortableRoot.lastChild);this.iconGardenSortableGroup.removeSortable(this._getAppShaftedByBookmarkableApp());}else{this.iconGardenSortableRoot.appendChild(div);}
this._addIconGardenSortable.bind(this,appID).defer();this._hideBookmarkableApp();this._saveBookmarksOrder.bind(this,ApplicationDock.SaveBookmarksSource.BOOKMARK_CURRENT_APP).defer();},_handleMsg:function(channel,obj){if(obj.type=='bookmarks'){var newSortedList=this._getSortedList(obj.bookmarks);if(!are_equal(this.sortedList,newSortedList)){this.applications=obj.bookmarks;this.sortedList=newSortedList;this._resetApplicationMenu();this._resetIconGarden();}
var message={sender:this,applications:this.sortedList};Arbiter.inform(ApplicationDock.BOOKMARKS_CHANGED,message);return true;}
return false;}}
if (window.Bootloader) { Bootloader.done(["js\/presence\/applications.js"]); }